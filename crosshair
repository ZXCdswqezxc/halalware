-- crosshair_logic.lua
-- Вся логика прицела: переменные, UI, анимация, sticky, spin, поиск цели, текст под прицелом
-- Для использования: require и вызов crosshair.init()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local CoreGui = game:GetService("CoreGui")

local crosshair = {}

-- Глобальные параметры (можно менять через getgenv().crosshair)
getgenv().crosshair = getgenv().crosshair or {}
local cfg = getgenv().crosshair
cfg.color = cfg.color or Color3.fromRGB(0, 255, 255)
cfg.mode = cfg.mode or "Middle" -- "Middle", "Mouse", "custom"
cfg.sticky = cfg.sticky or false
cfg.enabled = cfg.enabled or false
cfg.spin = cfg.spin or false
cfg.resize = cfg.resize or false
cfg.position = cfg.position or nil -- Vector2, если mode == 'custom'

-- Внутренние переменные
local fovRadius = 125
local mode = cfg.mode
local col1 = cfg.color
local col2 = Color3.fromRGB(0, 0, 255)
local spinSpeed = 4
local textBelow = ""

-- UI-объекты
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CrosshairGui"
ScreenGui.Parent = CoreGui
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local Frame = Instance.new("Frame")
Frame.Name = "CrosshairFrame"
Frame.Parent = ScreenGui
Frame.Visible = cfg.enabled
Frame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
Frame.BackgroundTransparency = 0.6
Frame.BorderColor3 = Color3.fromRGB(0, 0, 0)
Frame.BorderSizePixel = 0

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(1, 0)
UICorner.Parent = Frame

local UIStroke = Instance.new("UIStroke")
UIStroke.Thickness = 1.3
UIStroke.Color = col1
UIStroke.Parent = Frame

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, col1),
    ColorSequenceKeypoint.new(1, col2)
}
gradient.Parent = Frame

-- Текст под прицелом (опционально)
local TextLabel = Instance.new("TextLabel")
TextLabel.Name = "CrosshairText"
TextLabel.Parent = Frame
TextLabel.BackgroundTransparency = 1
TextLabel.Size = UDim2.new(1, 0, 0, 20)
TextLabel.Position = UDim2.new(0, 0, 1, 0)
TextLabel.Font = Enum.Font.Arimo
TextLabel.Text = textBelow
TextLabel.TextColor3 = Color3.fromRGB(255,255,255)
TextLabel.TextScaled = true
TextLabel.TextStrokeTransparency = 0.5
TextLabel.Visible = false

-- Функция обновления цвета обводки
local function UpdateStrokeColor()
    local color1 = gradient.Color.Keypoints[1].Value
    UIStroke.Color = Color3.new(color1.R, color1.G, color1.B)
end

-- Функция обновления размера и позиции прицела
local function UpdateFrameSize(radius)
    Frame.Size = UDim2.new(0, radius * 2, 0, radius * 2)
    if mode == "Mouse" and Players.LocalPlayer then
        local mouse = Players.LocalPlayer:GetMouse()
        Frame.Position = UDim2.new(0, mouse.X - Frame.Size.X.Offset / 2, 0, mouse.Y - Frame.Size.Y.Offset / 2)
    elseif mode == "custom" and cfg.position then
        Frame.Position = UDim2.new(0, cfg.position.X - Frame.Size.X.Offset / 2, 0, cfg.position.Y - Frame.Size.Y.Offset / 2)
    else
        Frame.Position = UDim2.new(0.5, -Frame.Size.X.Offset / 2, 0.5, -Frame.Size.Y.Offset / 2)
    end
end

-- Анимация градиента (вращение)
spawn(function()
    while true do
        if cfg.spin then
            gradient.Rotation = (gradient.Rotation + spinSpeed) % 360
            UpdateStrokeColor()
        end
        task.wait(0.01)
    end
end)

-- Следование за мышью
if Players.LocalPlayer then
    local mouse = Players.LocalPlayer:GetMouse()
    mouse.Move:Connect(function()
        if mode == "Mouse" then
            Frame.Position = UDim2.new(0, mouse.X - Frame.Size.X.Offset / 2, 0, mouse.Y - Frame.Size.Y.Offset / 2)
        end
    end)
end

-- Sticky на цель
local function findClosestPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge
    for _, Plr in ipairs(Players:GetPlayers()) do
        if Plr ~= Players.LocalPlayer and Plr.Character and Plr.Character:FindFirstChild("HumanoidRootPart") then
            local screenPos, onScreen = Camera:WorldToViewportPoint(Plr.Character.HumanoidRootPart.Position)
            if onScreen then
                local center = Vector2.new(Frame.AbsolutePosition.X + Frame.AbsoluteSize.X / 2, Frame.AbsolutePosition.Y + Frame.AbsoluteSize.Y / 2)
                local dist = (center - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                if dist < closestDistance and dist <= fovRadius then
                    closestPlayer = Plr
                    closestDistance = dist
                end
            end
        end
    end
    return closestPlayer
end

-- Heartbeat: sticky, resize, enable/disable
RunService.Heartbeat:Connect(function()
    Frame.Visible = cfg.enabled
    mode = cfg.mode
    if cfg.resize then
        -- Можно добавить динамическое изменение радиуса (например, по дистанции до цели)
        -- fovRadius = ...
    end
    UpdateFrameSize(fovRadius)
    if cfg.sticky then
        local target = findClosestPlayer()
        if target and target.Character then
            local part = target.Character:FindFirstChild("HumanoidRootPart")
            if part then
                local pos = Camera:WorldToViewportPoint(part.Position)
                cfg.mode = "custom"
                cfg.position = Vector2.new(pos.X, pos.Y)
            end
        end
    end
    -- Текст под прицелом (если нужно)
    if textBelow ~= "" then
        TextLabel.Text = textBelow
        TextLabel.Visible = true
    else
        TextLabel.Visible = false
    end
end)

-- API для изменения параметров
function crosshair.setText(text)
    textBelow = text or ""
end
function crosshair.setRadius(r)
    fovRadius = r or 125
end
function crosshair.setColors(c1, c2)
    col1 = c1 or col1
    col2 = c2 or col2
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, col1),
        ColorSequenceKeypoint.new(1, col2)
    }
end
function crosshair.setMode(m)
    mode = m or "Middle"
    cfg.mode = mode
end
function crosshair.setEnabled(v)
    cfg.enabled = v and true or false
    Frame.Visible = cfg.enabled
end
function crosshair.init()
    -- Можно вызвать для повторной инициализации, если нужно
    UpdateFrameSize(fovRadius)
    Frame.Visible = cfg.enabled
end

return crosshair 
